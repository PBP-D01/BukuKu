{% extends 'base.html' %}

{% block meta %}
{% endblock meta %}

{% block content %}
<section class="h-100 gradient-custom">
    <div class="container py-5">
      <h1>My Cart</h1>
      <div class="row d-flex justify-content-center my-4">
        <div class="col-md-8">
          <div class="row d-flex justify-content-center my-4">
            <h5 class="mb-0" id="item_in_cart"></h5>
          </div>
          <div class="row d-flex justify-content-left my-4" id="cart_card">
          </div>
        </div>
          
        <div class="col-md-4">
          <div class="card mb-4">
            <div class="card-header py-3">
              <h5 class="mb-0">Summary</h5>
            </div>
            <div class="card-body">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                  Total Item
                  <span id="total_item"></span>
                </li>
                <li
                  class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                  <div>
                    <strong>Total amount</strong>
                  </div>
                  <span id="total_price"><strong></strong></span>
                </li>
              </ul>
  
              <button type="button" class="btn btn-primary btn-lg btn-block">
                Go to checkout
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
 </section>

<script>
  async function getCartBook() {
    return fetch("/cart/get-cart/").then((res) => res.json())
  }

  async function refreshBooks() {
    const carts = await getCartBook()

    document.getElementById("cart_card").innerHTML = ""
    let htmlStringCard = ``
    let totalBook = 0
    let totalPrice = 0
    let totalAmount = 0
    carts.forEach((cart) => {
        let price = cart.book_amount * cart.book_price
        totalPrice += price
        totalAmount += cart.book_amount
        totalBook += 1
        htmlStringCard += 
        `<div class="card mb-4" style="max-width: 45rem; min-height: 200px;">
          <div class="card-body">
            <div class="row d-flex justify-content-left my-4">
              <div class="col-lg-3 col-md-12 mb-4 mb-lg-0">
                  <div class="bg-image hover-overlay hover-zoom ripple rounded" data-mdb-ripple-color="light">
                    <img src="${cart.book_img}"
                      class="w-100" alt="Book Image" />
                    <a href="#!">
                      <div class="mask" style="background-color: rgba(251, 251, 251, 0.2)"></div>
                    </a>
                  </div>
              </div>

              <div class="col">
                <p><strong>${cart.book_title}</strong></p>
                <p>Author: ${cart.book_author}</p>
                <p class="text-start text-md-left">
                  <strong>$${price.toFixed(2)}</strong>
                </p>
          `

        // if(cart.item_stock == 0)
        //     htmlStringCard += `
        //         <p class="text-start text-md-center">Out of Stock<p>`
        // else {
          htmlStringCard += `
                <div class="d-flex mb-4" style="max-width: 300px">
                  <button type="button" class="btn btn-primary h-25 me-2" data-mdb-toggle="tooltip"
                  title="Remove item" onclick="deleteCart(${cart.id})">
                    <img width="10" height="10" src="https://www.iconsdb.com/icons/preview/white/trash-6-xxl.png" />
                  </button>
                  <button class="btn btn-primary h-25 me-2"
                    onclick="decrease(${cart.id})">
                    -
                  </button>

                  <div class="form-outline">
                    <input text-allign="center" width="50" id="form1" min="1" name="quantity" value="${cart.book_amount}" type="number" class="form-control" readonly/>
                  </div>

                  <button class="btn btn-primary h-25 ms-2"
                    onclick="increase(${cart.id})">
                    +
                  </button>
                </div>`
        // }

        htmlStringCard += `
              </div>
            </div>
          </div>
          <div class="card-footer"></div>
        </div>`
    })
    htmlStringCard += `<h6 class="mb-0"><a href="/" class="text-body"><img widht="30" height="30" src="https://cdn.icon-icons.com/icons2/1674/PNG/512/arrowback_111142.png"></img>Back to shop</a></h6>`
    document.getElementById("cart_card").innerHTML = htmlStringCard
    document.getElementById("item_in_cart").innerHTML = totalBook + " Item added"
    document.getElementById("total_price").innerHTML = `$`+ totalPrice.toFixed(2)
    document.getElementById("total_item").innerHTML = totalAmount
  }

  refreshBooks()

  async function increase(cartId){
    fetch("/cart/increase-cart/" + cartId, {
    method: "POST",
    }).then(refreshBooks)
    document.querySelector('input[type=number]').stepUp()
  }

  async function decrease(cartId){
    fetch("/cart/decrease-cart/" + cartId, {
        method: "POST",
    }).then(refreshBooks)
    document.querySelector('input[type=number]').stepUp()
  }

  async function deleteCart(cartId){
    fetch("/cart/delete-cart/" + cartId, {
        method: "POST",
    }).then(refreshBooks)
  }  
</script>
{% endblock content %} 